---
title: "Quick start guide"
author: "Martin Westgate"
date: '2024-05-10'
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Quick start guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
library(galaxias)
```

`galaxias` is an R package to help users build repositories that are optimised
for storing, documenting and sharing biodiversity data. These repositories can 
be seamlessly converted into a **Darwin Core Archive**, the data standard used 
by the [Global Biodiversity Information Facility (GBIF)](https://gbif.org) and
it's partner nodes.


## Start a new project

To start a new data project in RStudio, simply click:

`File` > `New Project` > `New Directory` > `Biodiversity Data Project using galaxias` 

(Note: if this is your first time installing `galaxias`, you will need to close 
and reopen RStudio for this menu item to appear)

Alternatively, you can use the following function in the console:

```{r, eval=FALSE}
library(galaxias)
create_bd_project("myprojectname")
```

If you are using RStudio, both options should launch a new RStudio instance for
that project, which will have the following structure:

```
├── README.md                        : Darwin Core Metadata statement in .md format
├── metadata.md                      : Metadata statement for data in this project
├── projectname.Rproj                : RStudio project file
├── data-raw                         : Folder to store source data
│   └── data_manipulation_script.R   : Script with example code
└── data                             : Folder to store processed data
```

It is a good idea to write some basic information in your `README.Rmd` file
first, as this provides guidance to your users as to what your package contains,
as well as what they are allowed to use it for.


## Adding data to your project

We recommend that you first add your data to the `data-raw` folder, then use a 
script within that folder to manipulate it to a suitable interchange format 
(such as Darwin Core). Let's assume, for example, that your data is looks like 
this:

```{r}
library(tibble)

df <- tibble(
  latitude = c(-35.310, "-35.273"), # deliberate error for demonstration purposes
  longitude = c(149.125, 149.133),
  date = c("14-01-2023", "15-01-2023"),
  time = c("10:23", "11:25"),
  species = c("Callocephalon fimbriatum", "Eolophus roseicapilla"))
```

(Note that normally you'd import your data from an external file (e.g. using
`readr::read_csv()`), but we've constructed one here for example purposes.)

Just as we used `usethis` syntax when building our directory, `galaxias`
provides a set of helper functions for adding or manipulating columns to 
conform to the Darwin Core standard. Each function starts with a `use_`
prefix.

To give an example of what we mean, here is an example workflow:

```{r}
dwc_df <- df |>
  use_coordinates(decimalLatitude = latitude,
                  decimalLongitude = longitude)
```

In this case, `decimalLatitude` is recorded as a string, not a number; we can
correct as follows:
 

```{r}
dwc_df <- df |>
  use_coordinates(decimalLatitude = as.numeric(latitude),
                  decimalLongitude = longitude)
```

A minimally complete set of individual observations would include:

```{r}
occurrences <- df |>
  # basic requirements of Darwin Core
  use_occurrenceID() |> 
  use_basisOfRecord("humanObservation")
  # place and time
  use_coordinates(latitude, 
                  longitude) |>
  use_locality(country = "Australia", 
               locality = "City of Town") |>
  use_eventDate(date = date, time = time) |>
  # taxonomy
  use_scientificName(scientificName = species, 
                     scientificNameRank = "species") |>
  use_taxonomy(kingdom = "Animalia", 
               phylum = "Aves") 
```

Note that this deliberately includes some redundancy. The coordinate data are
useful by themselves, for example, but in case of ambiguity it is useful to
specify a text string given some information on location. Similarly, the 
`scientificName` field should be sufficient to identify the taxon in question, 
but adding higher taxonomic information makes the identification less ambiguous.

Although it is possible to provide data as a set of unrelated observations,
this structure doesn't reflect the way in which ecological surveys are typically
conducted. If, for example, you have conducted a survey in which many species
can be detected at once, you can try:

(add code block here showing `use_events()` and `use_abundance()`)


(add example of refining only to DwC terms)

We have saved our tibble as an object with a Darwin Core-specific name, so we 
can save it out with `use_bd_data()`:

```{r}
use_bd_data(occurrences)
```

If your object is not a valid Darwin Core file name, use `readr::write_csv` 
instead:

```{r, eval=FALSE}
library(readr)
write_csv(df, "./data/occurrences.csv")
```

If your data are _already_ in Darwin Core format, you can simply place them 
in the data folder and remove your `data-raw` folder.


## Adding package metadata

Darwin Core Archives use `xml` files to store metadata, but this format is 
tricky to work with for data entry. Therefore, we suggest that you store your 
metadata as a markdown file. You can generate a file called `metadata.md` 
in your project directory by calling:

```{r, eval=FALSE}
use_bd_metadata()
```



## Check your respository

Darwin Core may be an unfamiliar format, so it can be useful to 'check' your
data for common issues. We suggest first using `check_dwca()`:




Alternatively, you can use the ALA 'validate' API to check your data (not functional!)

```{r, eval=FALSE}
validate_dwca()
```

## Sharing your data

build_dwca() # convert to a DwCA

This does the following steps:

  * looks for data and builds a schema using `use_bd_schema()`
  * converts `schema.md` and `metadata.md` to `xml`
  * zips data and metadata into a DwCA

`publish_dwca()` can take a pre-built archive if you have already run 
`build_dwca()`, or can build one for you in a temporary directory and send that.